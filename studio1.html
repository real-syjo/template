<!DOCTYPE html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ocean AI</title>
    <meta name="description" content="Portfolio for world-renowned software engineer soyeon">
    <meta name="author" content="soyeon">

    <script src="https://kit.fontawesome.com/7ebfe642cb.js" crossorigin="anonymous"></script>
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Do+Hyeon&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="studioStyle1.css"/>
    <script src="studio1.js" defer></script>

    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/emailjs-com@2.4.1/dist/email.min.js"> </script>
    <script src="https://code.jquery.com/jquery-latest.min.js"></script>
</head>

<body>
    <section id="home">
      <div id="stage" class="shrink-wrap">

        
          <!-- 기존 콘텐츠 -->
        <div class="shrink-scale">
          <div class="your-panel">
            <div class="wrap">
                <!-- 하단: 도넛 + 범례 -->
                <div class="card"  data-step="0">
                  <div class="main">
                    <div class="box" id="progressBox">
                      <div class="progress">
                        <div class="bar" role="progressbar" aria-valuemin="0" aria-valuemax="100">
                          <div class="fill" id="chipProgress"></div>
                          
                        </div>
                        <div class="percent" id="chipPercent">0%</div>
                      </div>
                    </div>

                   <div class="box" id="box">
                        <div class="slideshow-container">
                          <div class="slide">
                             앞에서 선택한 데이터를 활용할 수 있도록 전처리가 필요해요.
                          </div>

                          <!-- 버튼 -->
                          <a class="prev" onclick="plusSlides(-1)">&#10094;</a>
                          <a class="next" onclick="plusSlides(1)">&#10095;</a>

                          <!-- 점 -->
                          <div class="dots">
                            <span class="dot" onclick="currentSTSlide(1)"></span>
                            <span class="dot" onclick="currentSlide(2)"></span>
                            <span class="dot" onclick="currentSlide(3)"></span>
                          </div>
                          
                        </div>
                
                        <div class="recommand" id="recommand"></div>
                            <button id="choiceBtn" >항목선택하기</button>
                        </div>
                         
                       </div>     
                      </div> 
                    </div> 
                  </div>
                  </div> 
                </div>
            </div>
          </div>
  
    </div>
    </section>
<!-- Modal -->
<div id="choiceModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    
    <h2>항목 선택</h2>
    <div class="modal-boxes">
      <div class="box" data-key="box1">박스 1</div>
      <div class="box" data-key="box2">박스 2</div>
      <div class="box" data-key="box3">박스 3</div>
      <div class="box" data-key="box4">박스 4</div>
      <div class="box" data-key="box5">박스 5</div>
      <div class="box" data-key="box6">박스 6</div>
      <div class="box" data-key="box7">박스 7</div>
      <div class="box" data-key="box8">박스 8</div>
      <div class="box" data-key="box9">박스 9</div>
      <div class="box" data-key="box10">박스 10</div>
      <div class="box" data-key="box11">박스 11</div>
      <div class="box" data-key="box12">박스 12</div>
      <div class="box" data-key="box13">박스 13</div>
      <div class="box" data-key="box14">박스 14</div>
      <div class="box" data-key="box15">박스 15</div>
      <div class="box" data-key="box16">박스 16</div>
      <div class="box" data-key="box17">박스 17</div>
      <div class="box" data-key="box18">박스 18</div>
      <div class="box" data-key="box19">박스 19</div>
      <div class="box" data-key="box20">박스 20</div>
      <div class="box" data-key="box21">박스 21</div>
      <div class="box" data-key="box22">박스 22</div>
      <div class="box" data-key="box23">박스 23</div>
      <div class="box" data-key="box24">박스 24</div>
      <div class="box" data-key="box25">박스 25</div>
    </div>
  </div>
</div>
</body>
</html>

<script>

  (() => {
  let __slideTimer = null;

  // 안전장치: 페이지 숨김 시 일시정지(선택)
  function stopSlideShow() {
    clearInterval(__slideTimer);
    __slideTimer = null;
  }
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) stopSlideShow();
  });

  // 부모가 보내는 신호를 받은 뒤에만 시작
  window.addEventListener('message', (e) => {
    if (e?.data?.type === 'START_SLIDES') {
      window.startSlideShow(e.data.interval || 3000);
    }
  });

  
})();

// ===== #signup3 폼 ↔ 도넛 연동 (폼이 들어있는 카드 안의 도넛만 다시 그림) =====
// ✅ 진행률 바 업데이트 함수
// ✅ 칩 개수 기반 진행률 (추천DATA .chip + KW 시트 .kw-chip)
function updateChipProgress() {
  const total = document.querySelectorAll('#legend .chip, .kw-chip').length;
  const done  = document.querySelectorAll('#legend .chip.active, .kw-chip.active').length;

  const percent = total ? Math.round((done / total) * 100) : 0;

  const fill  = document.getElementById('chipProgress');
  const label = document.getElementById('chipPercent');

  if (fill)  fill.style.width = percent + '%';
  if (label) label.textContent = percent + '%';

  // (선택) 상단 단계 게이지 색 업데이트가 필요하면 유지
  if (typeof renderGauge === 'function' && typeof currentStep !== 'undefined') {
    blockStates[currentStep] = (done===0) ? 'empty' : (done<total ? 'partial' : 'done');
    renderGauge();
  }
}


// ✅ 칩 선택 시 프로그래스바 갱신하도록 수정
function updateDonutProgressFromChips(){
  updateChipProgress();
}


// 추천DATA 칩 토글(위임)
document.addEventListener('click', (e)=>{
  const chip = e.target.closest('#legend .chip');
  if (!chip) return;

  const label = chip.textContent.trim();
  const item  = legendData.find(d => d.label === label);
  if (!item) return;

  item.selected = !item.selected;
  chip.classList.toggle('active', item.selected);

  updateChipProgress();   // ✅ 진행률 갱신
});


(function setupRecommandInput() {
  const rc = document.getElementById("recommand");
  const input = document.getElementById("recommandInput");
  if (!rc || !input) return;

  input.addEventListener("change", () => {   // 입력 끝나고 focus out
    addCollapseBelow(rc, input.value.trim());
  });

  input.addEventListener("keydown", (e) => { // 엔터 누르면 collapse 추가
    if (e.key === "Enter") {
      e.preventDefault();
      addCollapseBelow(rc, input.value.trim());
    }
  });

  function addCollapseBelow(container, text) {
    if (!text) return;

    // 기존 collapse 있으면 제거
    const oldCollapse = container.querySelector(".dynamic-collapse");
    if (oldCollapse) oldCollapse.remove();

    // collapse 새로 추가
    const collapseEl = document.createElement("div");
    collapseEl.className = "collapse dynamic-collapse";
    collapseEl.innerHTML = `
      <button class="collapse__btn" id="rc-btn" aria-expanded="false" aria-controls="rc-panel">
        입력 결과 보기
      </button>
      <div class="collapse__content" id="rc-panel" role="region" aria-labelledby="rc-btn">
        <p>입력한 내용: <strong>${text}</strong></p>
        <p>여기에 추천 데이터를 기반으로 한 설명이나 옵션을 넣을 수 있습니다.</p>
      </div>
    `;
    container.appendChild(collapseEl);

    // collapse 토글 이벤트
    const btn = collapseEl.querySelector(".collapse__btn");
    const panel = collapseEl.querySelector(".collapse__content");
    btn.addEventListener("click", () => {
      const willOpen = panel.classList.toggle("open");
      btn.setAttribute("aria-expanded", willOpen);
    });
  }
})();

// 마지막 input(5번째)에서만 confirm 실행
document.addEventListener('input', (e) => {
  if (!e.target.matches('#recommand .recommend-input')) return;

  const rc = document.getElementById('recommand');
  if (!rc) return;

  const inputs = rc.querySelectorAll('.recommend-input');

  // 🔹 마지막 input(예: 5번째)
  if (inputs.length === 4) {
    const lastInput = inputs[inputs.length - 1];

    if (e.target === lastInput && lastInput.value.trim() !== '') {
      // 이미 생성된 링크가 없다면 rc의 맨 아래에 추가
      if (!rc.querySelector('.go-next-link')) {
        rc.insertAdjacentHTML("beforeend", `
          <div class="go-next-wrapper">
            <a href="/studio.html?step=2" target="_parent" class="go-next-link">
              👉 3step으로 이동하기
            </a>
          </div>
        `);
      }
    }
  }
});

function fitRecommandToViewport(){
  const el = document.getElementById('recommand');
  if (!el) return;

  const rect = el.getBoundingClientRect();
  const bottomGap = 16; // 하단 여유
  const excelBar = document.getElementById('excelBar');
  const barH = (excelBar && excelBar.classList.contains('show'))
    ? excelBar.getBoundingClientRect().height + 12
    : 0;

  const avail = Math.max(200, window.innerHeight - rect.top - bottomGap - barH);
  el.style.setProperty('--rc-max-h', `${avail}px`);
}

// 최초/리사이즈 시 반영
window.addEventListener('load', fitRecommandToViewport);
window.addEventListener('resize', fitRecommandToViewport);

// #recommand 내부가 변할 때도 갱신
const rcEl = document.getElementById('recommand');
if (rcEl) {
  const mo = new MutationObserver(() => requestAnimationFrame(fitRecommandToViewport));
  mo.observe(rcEl, { childList:true, subtree:true });
}

// ask-wrap 추가/정렬 등 주요 함수 뒤에도 호출(정의돼 있으면 덮어씌워 훅 연결)
['addAskWrap','enableAskWrapDragSort','reindexAskWraps','buildSelectBoxes'].forEach(fn=>{
  if (typeof window[fn] === 'function') {
    const orig = window[fn];
    window[fn] = function(...args){
      const r = orig.apply(this, args);
      requestAnimationFrame(fitRecommandToViewport);
      return r;
    };
  }
});

// ask-wrap 열고 닫을 때도 재계산
document.addEventListener('click', (e)=>{
  if (e.target.closest('.ask-wrap')) {
    requestAnimationFrame(fitRecommandToViewport);
  }
});

</script>
